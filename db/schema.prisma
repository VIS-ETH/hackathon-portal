datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

enum event_phase {
  REGISTRATION
  HACKING
  GRADING
  READONLY
}

enum event_role {
  ADMIN
  MENTOR
  STAKEHOLDER
  PARTICIPANT
  SIDEQUEST_MASTER
}

enum team_role {
  MENTOR
  MEMBER
}

model event {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // fields
  name                String      @unique
  start               DateTime
  end                 DateTime
  max_team_size       Int
  kdf_secret          String
  is_feedback_visible Boolean
  is_hidden           Boolean
  phase               event_phase

  // related models
  team                  team[]
  project               project[]
  sidequest             sidequest[]
  appointment           appointment[]
  event_role_assignment event_role_assignment[]
}

model team {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id   String  @db.Uuid
  project_id String? @db.Uuid

  // fields
  name  String
  index Int

  // relations
  event   event    @relation(fields: [event_id], references: [id])
  project project? @relation(fields: [project_id], references: [id])

  // related models
  team_role_assignment team_role_assignment[]
  project_preference   project_preference[]
  sidequest_score      sidequest_score[]
}

model user {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // fields
  auth_id String
  name    String

  // related models
  event_role_assignment event_role_assignment[]
  team_role_assignment  team_role_assignment[]
  sidequest_attempt     sidequest_attempt[]
}

model event_role_assignment {
  user_id  String     @db.Uuid
  event_id String     @db.Uuid
  role     event_role

  // relations
  user  user  @relation(fields: [user_id], references: [id])
  event event @relation(fields: [event_id], references: [id])

  // meta
  @@id([user_id, event_id, role])
}

model team_role_assignment {
  user_id String    @db.Uuid
  team_id String    @db.Uuid
  role    team_role

  // relations
  user user @relation(fields: [user_id], references: [id])
  team team @relation(fields: [team_id], references: [id])

  // meta
  @@id([user_id, team_id, role])
}

model project {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  title   String
  content String

  // relations
  event event @relation(fields: [event_id], references: [id])

  // related models
  team               team[]
  project_preference project_preference[]
}

model project_preference {
  team_id    String @db.Uuid
  project_id String @db.Uuid

  // fields
  score Int

  // relations
  team    team    @relation(fields: [team_id], references: [id])
  project project @relation(fields: [project_id], references: [id])

  @@id([team_id, project_id])
}

model sidequest {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  name                    String
  description             String
  is_higher_result_better Boolean

  // relations
  event event @relation(fields: [event_id], references: [id])

  // related_models
  sidequest_attempt sidequest_attempt[]
}

model sidequest_attempt {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sidequest_id String @db.Uuid
  user_id      String @db.Uuid

  // fields
  result       Float
  attempted_at DateTime

  // relations
  sidequest sidequest @relation(fields: [sidequest_id], references: [id])
  user      user      @relation(fields: [user_id], references: [id])
}

model sidequest_score {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  team_id String @db.Uuid

  // fields
  score    Int
  valid_at DateTime

  // relations
  team team @relation(fields: [team_id], references: [id])
}

model appointment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  title       String
  description String?
  content     String?
  start       DateTime
  end         DateTime?

  // relations
  event event @relation(fields: [event_id], references: [id])
}
