datasource db {
  provider = "postgresql"
  url      = env("PORTAL__POSTGRES__URL")
}

enum event_visibility {
  HIDDEN // only visible to event staff
  INTERNAL // only visible to event affiliates
  PUBLIC // visible to everyone
}

enum event_phase {
  REGISTRATION
  HACKING
  GRADING
  FINISHED
}

enum event_role {
  ADMIN
  MENTOR
  STAKEHOLDER
  PARTICIPANT
  SIDEQUEST_MASTER
}

enum team_role {
  MENTOR
  MEMBER
}

enum expert_rating_category {
  FUNCTIONALITY
  UX
  PRESENTATION
}

enum media_usage {
  TEAM_PHOTO
}

model event {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // fields
  name                        String           @unique
  slug                        String           @unique
  start                       DateTime
  end                         DateTime
  welcome_content             String?
  documentation_content       String?
  max_team_size               Int
  max_teams_per_project       Int              @default(2) // max team per project
  sidequest_cooldown          Int // in minutes
  managed_address_template    String?
  direct_address_template     String?
  private_address_template    String?
  ssh_config_template         String?
  read_only                   Boolean          @default(true)
  projects_visible            Boolean          @default(false)
  project_assignments_visible Boolean          @default(false)
  feedback_visible            Boolean          @default(false)
  master_ai_api_key           Bytes?
  visibility                  event_visibility
  phase                       event_phase

  discord_server_id String?
  discord_config    String? @db.Text

  // related models
  team                  team[]
  project               project[]
  sidequest             sidequest[]
  appointment           appointment[]
  event_role_assignment event_role_assignment[]
  event_user_discord_id event_user_discord_id[]
}

model team {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id   String  @db.Uuid
  project_id String? @db.Uuid

  // fields
  name                     String
  slug                     String
  index                    Int
  password                 Bytes?
  ai_api_key               Bytes?
  extra_score              Float?
  comment                  String?
  photo_id                 String? @db.Uuid
  managed_address_override String?
  direct_address_override  String?
  private_address_override String?
  ssh_config_override      String?
  ingress_enabled          Boolean @default(false)
  ingress_config           Json    @default("{\"version\":1,\"mode\":\"Managed\",\"config\":{\"server_port\":8080,\"access_control_mode\":\"AuthenticationAuthorization\"}}")

  // relations
  event   event    @relation(fields: [event_id], references: [id])
  project project? @relation(fields: [project_id], references: [id])
  photo   upload?  @relation(fields: [photo_id], references: [id])

  // related models
  team_role_assignment team_role_assignment[]
  project_preference   project_preference[]
  sidequest_score      sidequest_score[]
  expert_rating        expert_rating[]

  // meta
  @@unique([event_id, name])
  @@unique([event_id, slug])
}

model user {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // fields
  auth_id String @unique
  name    String
  index   Int // used to differentiate users with the same name

  // related models
  event_role_assignment event_role_assignment[]
  team_role_assignment  team_role_assignment[]
  sidequest_attempt     sidequest_attempt[]
  expert_rating         expert_rating[]
  upload                upload[]
  event_user_discord_id event_user_discord_id[]

  // meta
  @@unique([name, index])
}

model event_role_assignment {
  user_id  String     @db.Uuid
  event_id String     @db.Uuid
  role     event_role

  // relations
  user  user  @relation(fields: [user_id], references: [id])
  event event @relation(fields: [event_id], references: [id])

  // meta
  @@id([user_id, event_id, role])
}

model event_user_discord_id {
  event_id   String @db.Uuid
  user_id    String @db.Uuid
  discord_id String

  // relations
  event event? @relation(fields: [event_id], references: [id])
  user  user?  @relation(fields: [user_id], references: [id])

  // meta
  @@id([user_id, event_id])
}

model team_role_assignment {
  user_id String    @db.Uuid
  team_id String    @db.Uuid
  role    team_role

  // relations
  user user @relation(fields: [user_id], references: [id])
  team team @relation(fields: [team_id], references: [id])

  // meta
  @@id([user_id, team_id, role])
}

model project {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  name    String
  slug    String
  content String

  // relations
  event event @relation(fields: [event_id], references: [id])

  // related models
  team               team[]
  project_preference project_preference[]

  // meta
  @@unique([event_id, name])
  @@unique([event_id, slug])
}

model project_preference {
  team_id    String @db.Uuid
  project_id String @db.Uuid

  // fields
  score Int

  // relations
  team    team    @relation(fields: [team_id], references: [id])
  project project @relation(fields: [project_id], references: [id])

  @@id([team_id, project_id])
}

model expert_rating {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // fields
  team_id  String                 @db.Uuid
  user_id  String                 @db.Uuid
  category expert_rating_category
  rating   Float

  // relations
  team team @relation(fields: [team_id], references: [id])
  user user @relation(fields: [user_id], references: [id])

  // meta
  @@unique([team_id, user_id, category])
}

model sidequest {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  name                    String
  slug                    String
  description             String
  is_higher_result_better Boolean

  // relations
  event event @relation(fields: [event_id], references: [id])

  // related_models
  sidequest_attempt sidequest_attempt[]

  // meta
  @@unique([event_id, name])
  @@unique([event_id, slug])
}

model sidequest_attempt {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sidequest_id String @db.Uuid
  user_id      String @db.Uuid

  // fields
  result       Float
  attempted_at DateTime

  // relations
  sidequest sidequest @relation(fields: [sidequest_id], references: [id])
  user      user      @relation(fields: [user_id], references: [id])
}

model sidequest_score {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  team_id String @db.Uuid

  // fields
  score    Float
  valid_at DateTime

  // relations
  team team @relation(fields: [team_id], references: [id])
}

model appointment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_id String @db.Uuid

  // fields
  title       String
  description String?
  content     String?
  start       DateTime
  end         DateTime?

  // relations
  event event @relation(fields: [event_id], references: [id])
}

model upload {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @db.Uuid

  // fields
  usage          media_usage
  content_type   String
  content_length BigInt
  requested_at   DateTime
  uploaded_at    DateTime?
  validated_at   DateTime?

  // relations
  user user @relation(fields: [user_id], references: [id])

  // related models
  team team[]
}
